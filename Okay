-- Go credit script
local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

local Window = Fluent:CreateWindow({
    Title = "Fluent " .. Fluent.Version,
    SubTitle = "by dawid",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 460),
    Acrylic = true, -- The blur may be detectable, setting this to false disables blur entirely
    Theme = "Dark",
    MinimizeKey = Enum.KeyCode.LeftControl -- Used when theres no MinimizeKeybind
})

--Fluent provides Lucide Icons https://lucide.dev/icons/ for the tabs, icons are optional
local Tabs = {
    Main = Window:AddTab({ Title = "EspTab", Icon = "" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" })
}

local Options = Fluent.Options

do
    Fluent:Notify({
        Title = "Notification",
        Content = "This is a notification",
        SubContent = "SubContent", -- Optional
        Duration = 5 -- Set to nil to make the notification not disappear
    })

local ReplicatedStorage = game:GetService("ReplicatedStorage");
	local Players = game:GetService("Players");
	local RunService = game:GetService("RunService");
	local LP = Players.LocalPlayer;
	local ESPConfig = {
		HighlightMurderer = false,
		HighlightInnocent = false,
		HighlightSheriff = false
	};
	local Murder, Sheriff, Hero;
	local roles = {};
	function CreateHighlight(player)
		if ((player ~= LP) and player.Character and  not player.Character:FindFirstChild("Highlight")) then
			local highlight = Instance.new("Highlight");
			highlight.Parent = player.Character;
			highlight.Adornee = player.Character;
			highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop;
			return highlight;
		end
		return player.Character and player.Character:FindFirstChild("Highlight") ;
	end
	function RemoveAllHighlights()
		for _, player in pairs(Players:GetPlayers()) do
			if (player.Character and player.Character:FindFirstChild("Highlight")) then
				player.Character.Highlight:Destroy();
			end
		end
	end
	function UpdateHighlights()
		for _, player in pairs(Players:GetPlayers()) do
			if ((player ~= LP) and player.Character) then
				local highlight = player.Character:FindFirstChild("Highlight");
				if  not (ESPConfig.HighlightMurderer or ESPConfig.HighlightInnocent or ESPConfig.HighlightSheriff) then
					if highlight then
						highlight:Destroy();
					end
					return;
				end
				local shouldHighlight = false;
				local color = Color3.new(0, 1, 0);
				if ((player.Name == Murder) and IsAlive(player) and ESPConfig.HighlightMurderer) then
					color = Color3.fromRGB(255, 0, 0);
					shouldHighlight = true;
				elseif ((player.Name == Sheriff) and IsAlive(player) and ESPConfig.HighlightSheriff) then
					color = Color3.fromRGB(0, 0, 255);
					shouldHighlight = true;
				elseif (ESPConfig.HighlightInnocent and IsAlive(player) and (player.Name ~= Murder) and (player.Name ~= Sheriff) and (player.Name ~= Hero)) then
					color = Color3.fromRGB(0, 255, 0);
					shouldHighlight = true;
				elseif ((player.Name == Hero) and IsAlive(player) and  not IsAlive(game.Players[Sheriff]) and ESPConfig.HighlightSheriff) then
					color = Color3.fromRGB(255, 250, 0);
					shouldHighlight = true;
				end
				if shouldHighlight then
					highlight = CreateHighlight(player);
					if highlight then
						highlight.FillColor = color;
						highlight.OutlineColor = color;
						highlight.Enabled = true;
					end
				elseif highlight then
					highlight.Enabled = false;
				end
			end
		end
	end
	function IsAlive(player)
		for name, data in pairs(roles) do
			if (player.Name == name) then
				return  not data.Killed and  not data.Dead ;
			end
		end
		return false;
	end
	local function UpdateRoles()
		roles = ReplicatedStorage:FindFirstChild("GetPlayerData", true):InvokeServer();
		for name, data in pairs(roles) do
			if (data.Role == "Murderer") then
				Murder = name;
			elseif (data.Role == "Sheriff") then
				Sheriff = name;
			elseif (data.Role == "Hero") then
				Hero = name;
			end
		end
	end

Tabs.EspTab:Section({
		Title = gradient("Special ESP", Color3.fromHex("#b914fa"), Color3.fromHex("#7023c2"))
	});
	Tabs.EspTab:Toggle({
		Title = gradient("Higlight Murder", Color3.fromHex("#e80909"), Color3.fromHex("#630404")),
		Default = false,
		Callback = function(state)
			ESPConfig.HighlightMurderer = state;
			if  not state then
				UpdateHighlights();
			end
		end
	});
	Tabs.EspTab:Toggle({
		Title = gradient("Highlight Innocent", Color3.fromHex("#0ff707"), Color3.fromHex("#1e690c")),
		Default = false,
		Callback = function(state)
			ESPConfig.HighlightInnocent = state;
			if  not state then
				UpdateHighlights();
			end
		end
	});
	Tabs.EspTab:Toggle({
		Title = gradient("Highlight Sheriff", 
		Default = false,
		Callback = function(state)
			ESPConfig.HighlightSheriff = state;
			if  not state then
				UpdateHighlights();
			end
		end
	});
	local gunDropESPEnabled = false;
	local gunDropHighlight = nil;
	local mapPaths = {
		"ResearchFacility",
		"Hospital3",
		"MilBase",
		"House2",
		"Workplace",
		"Mansion2",
		"BioLab",
		"Hotel",
		"Factory",
		"Bank2",
		"PoliceStation"
	};
	local function createGunDropHighlight(gunDrop)
		if (gunDropESPEnabled and gunDrop and  not gunDrop:FindFirstChild("GunDropHighlight")) then
			local highlight = Instance.new("Highlight");
			highlight.Name = "GunDropHighlight";
			highlight.FillColor = Color3.fromRGB(255, 215, 0);
			highlight.OutlineColor = Color3.fromRGB(255, 165, 0);
			highlight.Adornee = gunDrop;
			highlight.Parent = gunDrop;
		end
	end
	local function updateGunDropESP()
		for _, mapName in pairs(mapPaths) do
			local map = workspace:FindFirstChild(mapName);
			if map then
				local gunDrop = map:FindFirstChild("GunDrop");
				if (gunDrop and gunDrop:FindFirstChild("GunDropHighlight")) then
					gunDrop.GunDropHighlight:Destroy();
				end
			end
		end
		if gunDropESPEnabled then
			for _, mapName in pairs(mapPaths) do
				local map = workspace:FindFirstChild(mapName);
				if map then
					local gunDrop = map:FindFirstChild("GunDrop");
					if gunDrop then
						createGunDropHighlight(gunDrop);
					end
				end
			end
		end
	end
	local function monitorGunDrops()
		for _, mapName in pairs(mapPaths) do
			local map = workspace:FindFirstChild(mapName);
			if map then
				map.ChildAdded:Connect(function(child)
					if (child.Name == "GunDrop") then
						createGunDropHighlight(child);
					end
				end);
			end
		end
	end
	monitorGunDrops();
	Tabs.EspTab:Toggle({
		Title = gradient("GunDrop Highlight", Color3.fromHex("#ffff00"), Color3.fromHex("#4f4f00")),
		Default = false,
		Callback = function(state)
			gunDropESPEnabled = state;
			updateGunDropESP();
		end
	});
	workspace.ChildAdded:Connect(function(child)
		if table.find(mapPaths, child.Name) then
			task.wait(2);
			updateGunDropESP();
		end
	end);
	RunService.RenderStepped:Connect(function()
		UpdateRoles();
		if (ESPConfig.HighlightMurderer or ESPConfig.HighlightInnocent or ESPConfig.HighlightSheriff) then
			UpdateHighlights();
		end
	end);
	Players.PlayerRemoving:Connect(function(player)
		if (player == LP) then
			RemoveAllHighlights();
		end
	end);
